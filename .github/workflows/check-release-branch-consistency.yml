name: Ensure main contains release commits

on:
  pull_request:
    branches:
      - release/** # PR 目標是 release/*
    paths-ignore:
      - '**.md' # 可選：略過文檔變更
    types: [opened, synchronize, reopened]

jobs:
  check-main-contains:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'hotfix/')
    steps:
      - name: Checkout all history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 取得完整 Git 歷史，才能比較 commit

      - name: Check that main contains hotfix commits
        run: |
          echo "Checking if commits from ${{ github.head_ref }} are already in main..."
          git fetch origin main
          MISSING=$(git cherry origin/main HEAD | grep '^+' || true)

          if [[ -n "$MISSING" ]]; then
            echo "❌ The following commits from '${{ github.head_ref }}' are NOT in 'main':"
            echo "$MISSING"
            echo ""
            echo "Please merge '${{ github.head_ref }}' into 'main' before merging into release."
          else
            echo "✅ All commits from '${{ github.head_ref }}' are already in 'main'."
          fi
